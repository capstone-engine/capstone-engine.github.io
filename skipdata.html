<!DOCTYPE html>
<html>
  <head>
    <title>SKIPDATA mode – Capstone – The Ultimate Disassembler</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="The Ultimate Disassembler">
    <meta property="og:description" content="The Ultimate Disassembler" />
    
    <meta name="author" content="Capstone" />

    
    <meta property="og:title" content="SKIPDATA mode" />
    <meta property="twitter:title" content="SKIPDATA mode" />
    

    <link rel="icon" type="image/png" sizes="16x16" href="/16x16.png">
    <link rel="icon" type="image/png" sizes="24x24" href="/24x24.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/48x48.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/64x64.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="/128x128.png">
    <link rel="icon" type="image/png" sizes="256x256" href="/256x256.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/512x512.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">


    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Capstone - The Ultimate Disassembler" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/img/capstone.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Capstone</a></h1>
            <p class="site-description">The Ultimate Disassembler</p>
          </div>

          <nav>
            <a href="/download.html">Download</a>
            <a href="/documentation.html">Docs</a>
            <a href="/showcase.html">Showcase</a>
            <a href="/testimonial.html">Testimonials</a>
            <a href="/donate.html">Donate</a>
            <a href="/contact.html">Contact</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <h2>SKIPDATA mode</h2>

<p>(Note: at the moment, this option is only availabe in the <a href="https://github.com/aquynh/capstone/tree/next">next branch</a> of our Github repo. It will be integrated into the next release of Capstone)</p>

<p>By default, Capstone stops disassembling when it encounters a broken instruction. Most of the time, the reason is that this is data mixed inside the input, and it is understandable that Capstone does not understand this &quot;weird&quot; code.</p>

<p>Typically, you are recommended to dertermine yourself where the next code is, and then continue disassembling from that place. However, in some cases you just want to let Capstone automatically skip some data until it finds a legitimate instruction, then just carries on from there. Hence, the <strong>SKIPDATA</strong> mode is introduced for this purpose.</p>

<p>In general, this solution is suboptimal because Capstone can make a mistake deciding what is data, what is code. Only rely on a fact that input can be disassembled to determine the code start from there is fundamentally wrong, so you are warned: only use this mode when you know what you are doing.</p>

<hr>

<h3>1. Turn on SKIPDATA mode</h3>

<p>To tell Capstone to skip some (unknown) amount of data until the next legitimate instruction, simply use <em>cs_option()</em> to turn on option <em>CS<em>OPT</em>SKIPDATA</em> (which is <em>off</em> by default) as follows.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">csh</span> <span class="n">handle</span><span class="p">;</span>
<span class="n">cs_open</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>

<span class="c1">// turn on SKIPDATA mode</span>
<span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_SKIPDATA</span><span class="p">,</span> <span class="n">CS_OPT_ON</span><span class="p">);</span></code></pre></div>

<p><br>
The output of some X86 code with data mixed inside can be like the sample below</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1</span> Platform: X86 <span class="m">32</span> <span class="o">(</span>Intel syntax<span class="o">)</span>
<span class="lineno">2</span> Code: 0x8d 0x4c 0x32 0x08 0x01 0xd8 0x81 0xc6 0x34 0x12 0x00 0x00 0x00 0x91 0x92
<span class="lineno">3</span> Disasm:
<span class="lineno">4</span> 0x1000:   lea ecx, dword ptr <span class="o">[</span>edx + esi + 8<span class="o">]</span>
<span class="lineno">5</span> 0x1004:   add eax, ebx
<span class="lineno">6</span> 0x1006:   add esi, 0x1234
<span class="lineno">7</span> 0x100c:   .byte   0x00
<span class="lineno">8</span> 0x100d:   xchg    eax, ecx
<span class="lineno">9</span> 0x100e:   xchg    eax, edx</code></pre></div>

<p><br>
Readers can see that in <em>line 7</em>, Capstone skips 1 byte of data (<em>0x00</em>) and continues to disassemble from the next bytes in the input stream. In this case, actually Capstone considers the skip data a special instruction with instruction ID of <strong>zero</strong>, with mnemonic as &quot;<em>.byte</em>&quot; and operand string as a hex-code of the sequence of bytes it skipped.</p>

<p>NOTE that on this special &quot;data&quot; instruction, the <em>detail</em> pointer of struct <em>CsInsn</em> points to NULL, because obviously it has no detail. Therefore, programmers need to be careful not to access the detail pointer of this &quot;data&quot; instruction.</p>

<p>By default, for each iteration, Capstone skips 1 byte on <em>X86</em> architecture, 2 bytes on <em>Thumb</em> mode on <em>Arm</em> architecture, and 4 bytes for the rest. The reason while Capstone skips 1 byte on X86 is that X86 puts no restriction on instruction alignment, but other architectures enforces some requirements on this aspect.</p>

<p>When we do not want Capstone to skip data anymore, but just stop when hitting broken instruction, we can return to the default mode by simply turnning off SKIPDATA mode, as follwings.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// turn off SKIPDATA mode</span>
<span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_SKIPDATA</span><span class="p">,</span> <span class="n">CS_OPT_OFF</span><span class="p">);</span></code></pre></div>

<p><br>
For Python code, turning on and off this option can be done simply by modifying <em>skipdata</em> status of <em>Cs</em> class, like in the below code.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">md</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">)</span>

<span class="c"># By default, SKIPDATA mode is OFF. Now let&#39;s turn it ON</span>
<span class="n">md</span><span class="o">.</span><span class="n">skipdata</span> <span class="o">=</span> <span class="bp">True</span>
<span class="c"># From here onwards, Capstone skips data until it finds a legitimate instruction</span>
<span class="c"># .....</span>

<span class="c"># Turn off SKIPDATA mode, so we are back to the default mode</span>
<span class="n">md</span><span class="o">.</span><span class="n">skipdata</span> <span class="o">=</span> <span class="bp">False</span></code></pre></div>

<hr>

<h3>2. Customize the &quot;data&quot; instruction&#39;s mnemonic</h3>

<p>As presented above, Capstone considers data to be skipped an instruction with the default mnemonic &quot;<em>.byte</em>&quot;. To change this mnemonic, use <em>cs_option()</em> with <em>CS<em>OPT</em>SKIPDATA_SETUP</em>, as follows.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="lineno"> 1</span> <span class="n">csh</span> <span class="n">handle</span><span class="p">;</span>
<span class="lineno"> 2</span> <span class="n">cs_open</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="n">cs_opt_skipdata</span> <span class="n">skipdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="lineno"> 5</span>     <span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="s">&quot;db&quot;</span><span class="p">,</span>
<span class="lineno"> 6</span> <span class="p">};</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="c1">// customize SKIPDATA mode</span>
<span class="lineno"> 9</span> <span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_SKIPDATA_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skipdata</span><span class="p">);</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="c1">// Turn on SKIPDATA mode</span>
<span class="lineno">12</span> <span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_SKIPDATA</span><span class="p">,</span> <span class="n">CS_OPT_ON</span><span class="p">);</span></code></pre></div>

<p><br>
The code above is intuitive enough itself.</p>

<ul>
<li><p>Line 4: declare the customization with <em>cs<em>opt</em>skipdata</em> struct</p></li>
<li><p>Line 5: change mnemonic of the &quot;data&quot; instruction to &quot;db&quot;</p></li>
<li><p>Line 9: customize SKIPDATA mode with our struct above using <em>cs_option()</em> &amp; <em>CS<em>OPT</em>SKIPDATA_SETUP</em> option.</p></li>
</ul>

<p><br>
Thanks to this, the output of the same input in section 1 above will be as follwings (note the change on <em>line 7</em>).</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="lineno">1</span> Platform: X86 <span class="m">32</span> <span class="o">(</span>Intel syntax<span class="o">)</span>
<span class="lineno">2</span> Code: 0x8d 0x4c 0x32 0x08 0x01 0xd8 0x81 0xc6 0x34 0x12 0x00 0x00 0x00 0x91 0x92
<span class="lineno">3</span> Disasm:
<span class="lineno">4</span> 0x1000:   lea ecx, dword ptr <span class="o">[</span>edx + esi + 8<span class="o">]</span>
<span class="lineno">5</span> 0x1004:   add eax, ebx
<span class="lineno">6</span> 0x1006:   add esi, 0x1234
<span class="lineno">7</span> 0x100c:   db  0x00
<span class="lineno">8</span> 0x100d:   xchg    eax, ecx
<span class="lineno">9</span> 0x100e:   xchg    eax, edx</code></pre></div>

<p><br>
For Python code, this customization can be done easier thanks to the <em>skipdata_setup</em> getter, as follows.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">md</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">)</span>

<span class="c"># Customize the mnemonic of &quot;data&quot; instruction</span>
<span class="n">md</span><span class="o">.</span><span class="n">skipdata_setup</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c"># Turn on SKIPDATA mode</span>
<span class="n">md</span><span class="o">.</span><span class="n">skipdata</span> <span class="o">=</span> <span class="bp">True</span></code></pre></div>

<p><br>
As you can see, simply pass a <em>Python tuple</em> of <em>3 members</em> to <em>skipdata_setup</em>, with the <em>first member</em> is the <em>mnemonic</em> string, and the other two members as <em>None</em>.</p>

<hr>

<h3>3. Customize SKIPDATA with user-defined callback function</h3>

<p>By default, depending on architecture, Capstone skips a certain number of bytes on each iteration, as pointed out in section 1 above. In case we want to customize this, we can program a callback and setup that with the same option <em>CS<em>OPT</em>SKIPDATA_SETUP</em> above.</p>

<p>The user-defined callback is a function that returns the number of bytes to skip, which takes 3 arguments: the first is the input buffer passed to <em>cs<em>disasm</em>ex()</em>, the second is the offset of currently examining byte in the above input buffer, and the last is an user-data pointer.</p>

<p>Note that in case we no longer want to disassemble, we simply return <strong>zero</strong> (<em>value 0</em>) from the callback. In this case, Capstone will immediately bail out, and stop all the reverse process.</p>

<p>See the sample code below for how to setup the callback, in which the callback tells Capstone to always skip 2 bytes.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">size_t</span> <span class="nf">mycallback</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// always skip 2 bytes when encountering data</span>
    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">csh</span> <span class="n">handle</span><span class="p">;</span>
<span class="n">cs_open</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>

<span class="n">cs_opt_skipdata</span> <span class="n">skipdata</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">mnemonic</span> <span class="o">=</span> <span class="s">&quot;db&quot;</span><span class="p">,</span>        <span class="c1">// set mnemonic to &quot;db&quot;</span>
    <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mycallback</span><span class="p">,</span>  <span class="c1">// use the callback defined above</span>
    <span class="p">.</span><span class="n">user_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>       <span class="c1">// do not have user-data in this sample</span>
<span class="p">};</span>

<span class="c1">// customize SKIPDATA mode with our callback</span>
<span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_SKIPDATA_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skipdata</span><span class="p">);</span>

<span class="c1">// Turn on SKIPDATA mode</span>
<span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_SKIPDATA</span><span class="p">,</span> <span class="n">CS_OPT_ON</span><span class="p">);</span></code></pre></div>

<p><br>
For Python, this customization is easier: we just need to pass a <em>Python tuple</em> of <em>3 members</em> to <em>skipdata_setup</em>, with the <em>first member</em> is the <em>mnemonic</em> string, the <em>second</em> is the <em>callback function</em>, and the <em>third</em> is the <em>user-data</em>.</p>

<p>The same sample of the C code above, but in Python, is as follows.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">mycallback</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">2</span>

<span class="n">md</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">)</span>

<span class="c"># Customize the SKIPDATA mode with our callback</span>
<span class="n">md</span><span class="o">.</span><span class="n">skipdata_setup</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;db&quot;</span><span class="p">,</span> <span class="n">mycallback</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c"># Turn on SKIPDATA mode</span>
<span class="n">md</span><span class="o">.</span><span class="n">skipdata</span> <span class="o">=</span> <span class="bp">True</span></code></pre></div>

<hr>

<h3>4. Sample code for SKIPDATA mode</h3>

<p>For sample C code, see <a href="https://github.com/aquynh/capstone/blob/next/tests/test_skipdata.c">https://github.com/aquynh/capstone/blob/next/tests/test_skipdata.c</a></p>

<p>For sample Python code, see <a href="https://github.com/aquynh/capstone/blob/next/bindings/python/test_skipdata.py">https://github.com/aquynh/capstone/blob/next/bindings/python/test_skipdata.py</a></p>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:capstone.engine@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/aquynh/capstone"><i class="svg-icon github"></i></a>




<a href="https://www.twitter.com/capstone_engine"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    

  </body>
</html>
