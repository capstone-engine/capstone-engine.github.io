<!DOCTYPE html>
<html>
  <head>
    <title>Customize instruction mnemonic – Capstone – The Ultimate Disassembler</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="The Ultimate Disassembler">
    <meta property="og:description" content="The Ultimate Disassembler" />
    
    <meta name="author" content="Capstone" />

    
    <meta property="og:title" content="Customize instruction mnemonic" />
    <meta property="twitter:title" content="Customize instruction mnemonic" />
    

    <link rel="icon" type="image/png" sizes="16x16" href="/16x16.png">
    <link rel="icon" type="image/png" sizes="24x24" href="/24x24.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/48x48.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/64x64.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="/128x128.png">
    <link rel="icon" type="image/png" sizes="256x256" href="/256x256.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/512x512.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">


    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Capstone - The Ultimate Disassembler" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/img/capstone.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Capstone</a></h1>
            <p class="site-description">The Ultimate Disassembler</p>
          </div>

          <nav>
            <a href="/download.html">Download</a>
            <a href="/documentation.html">Docs</a>
            <a href="/showcase.html">Showcase</a>
            <a href="/testimonial.html">Testimonials</a>
            <a href="/donate.html">Donate</a>
            <a href="/contact.html">Contact</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <h2>Customize instruction mnemonic at run-time</h2>

<h3>1. Setup Capstone to customize mnemonic</h3>

<p>In some architectures, an instruction might have alternative mnemonic. Example is the <em>JNE</em> instruction on <em>X86</em>: this is also called <em>JNZ</em> by some disassemblers. The problem is that all the mnemonics are fixed in the engine and cannot be customized. For this reason, some disassembly tools built on top of Capstone have to use some tricks to modify mnemonics at the output for what they desire.</p>

<p>This has been changed with a new option <strong>CS_OPT_MNEMONIC</strong> (available in the Github branch <a href="https://github.com/aquynh/capstone/tree/next">next</a> now, and will be ready when version <em>4.0</em> is out). Use this option with <em>cs_option()</em> to customize instruction mnemonics, as in the sample C code below.</p>

<p><br></p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="lineno"> 1</span> <span class="n">csh</span> <span class="n">handle</span><span class="p">;</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="c1">// Customize mnemonic JNE to &quot;jnz&quot;</span>
<span class="lineno"> 4</span> <span class="n">cs_opt_mnem</span> <span class="n">my_mnem</span> <span class="o">=</span> <span class="p">{</span> <span class="n">X86_INS_JNE</span><span class="p">,</span> <span class="s">&quot;jnz&quot;</span> <span class="p">};</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs_open</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 7</span>     <span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_MNEMONIC</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">my_mnem</span><span class="p">);</span>
<span class="lineno"> 8</span>     <span class="c1">// from here onwards, disassembling will give JNE a mnemonic &quot;jnz&quot;</span>
<span class="lineno"> 9</span>     <span class="c1">// ...</span>
<span class="lineno">10</span> <span class="p">}</span></code></pre></div>

<p><br>
Below is the explanation for important lines of the above C sample.</p>

<ul>
<li><p>Line 4: Declare variables <em>my_mnem</em> of data type <em>cs_opt_mnem</em> to customize <em>JNE</em> instruction (indicated by <em>X86_INS_JNE</em>) to have mnemonic <em>&quot;jnz&quot;</em>.</p></li>
<li><p>Line 6: Intialize X86 engine of 32-bit mode.</p></li>
<li><p>Line 7: Call <em>cs_option</em> with option <em>CS_OPT_MNEMONIC</em>, and pass the address of <em>my_mnem</em> in the third parameter. After this, we can start disassembling and instruction <em>JNE</em> will have <em>&quot;jnz&quot;</em> mnemonic, rather than the default value <em>&quot;jne&quot;</em>.</p></li>
</ul>

<p><br>
The below Python code does the same thing as the above C sample. The only important difference is that we use method <em>mnemonic_setup()</em> to customize the menemonic of <em>JNE</em> instruction in <em>line 5</em>.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="kn">from</span> <span class="nn">capstone</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno">2</span> <span class="kn">from</span> <span class="nn">capstone.x86</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno">3</span> 
<span class="lineno">4</span> <span class="n">md</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">)</span>
<span class="lineno">5</span> <span class="n">md</span><span class="o">.</span><span class="n">mnemonic_setup</span><span class="p">(</span><span class="n">X86_INS_JNE</span><span class="p">,</span> <span class="s">&quot;jnz&quot;</span><span class="p">)</span></code></pre></div>

<p><br>
Finally, note that while the above samples are for X86, the same technique can be applied for all other architectures supported by Capstone. Because we can run <em>cs_option(CS_OPT_MNEMONIC)</em> as many times as we want, there is no limitation on the number of instructions we can customize.</p>

<hr>

<h3>2. Reset Capstone to the default mnemonic</h3>

<p>After customizing instruction mnemonic as in section 1 above, we can always reset Capstone to the default mnemonic, as in the sample C code below.</p>

<p><br></p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="lineno">1</span> <span class="c1">// Reset instruction JNE to use its default mnemonic</span>
<span class="lineno">2</span> <span class="n">cs_opt_mnem</span> <span class="n">default_mnem</span> <span class="o">=</span> <span class="p">{</span> <span class="n">X86_INS_JNE</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="lineno">3</span> 
<span class="lineno">4</span> <span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_MNEMONIC</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">default_mnem</span><span class="p">);</span>
<span class="lineno">5</span> <span class="c1">// from here onwards, our engine will switch back to the default mnemonic &quot;jne&quot; for JNE.</span></code></pre></div>

<p><br>
Basically, rather than using a string for the mnemonic, we pass the value <em>NULL</em> in <em>line 2</em> when declaring the <em>cs_opt_mnem</em> structure.</p>

<p><br>
The below Python sample does the same thing to reset the engine, which is self explanatory.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">md</span><span class="o">.</span><span class="n">mnemonic_setup</span><span class="p">(</span><span class="n">X86_INS_JNE</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></code></pre></div>

<hr>

<h3>3. More examples</h3>

<p>Find the full samples on how to use <em>CS_OPT_MNEMONIC</em> in the source of <a href="https://github.com/aquynh/capstone/blob/next/tests/test_customized_mnem.c">test_x86.c</a> or <a href="https://github.com/aquynh/capstone/blob/next/bindings/python/test_customized_mnem.py">test_x86.py</a>.</p>

<p><br>
When running these samples, the output is as follows.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">Disassemble X86 code with default instruction mnemonic
75 01       jne 0x1003

Now customize engine to change mnemonic from &#39;JNE&#39; to &#39;JNZ&#39;
75 01       jnz 0x1003

Reset engine to use the default mnemonic
75 01       jne 0x1003</code></pre></div>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:capstone.engine@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/aquynh/capstone"><i class="svg-icon github"></i></a>




<a href="https://www.twitter.com/capstone_engine"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    

  </body>
</html>
