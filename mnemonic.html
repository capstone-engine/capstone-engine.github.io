<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Capstone - Customize instruction mnemonic</title><link rel="stylesheet" href="css/style.css" type="text/css" media="all"><link rel="stylesheet" href="css/pygments.css" type="text/css" media="all"><link rel="alternate" href="feed/index.xml" type="application/atom+xml" title="Atom Feed"></head><body><div id="fb-root"></div> <script>!function(e,t,n){var c,o=e.getElementsByTagName(t)[0];e.getElementById(n)||(c=e.createElement(t),c.id=n,c.src="//connect.facebook.net/en_US/all.js#xfbml=1",o.parentNode.insertBefore(c,o))}(document,"script","facebook-jssdk")</script><script>!function(t,e,r){var n,s=t.getElementsByTagName(e)[0],i=/^http:/.test(t.location)?"http":"https";t.getElementById(r)||(n=t.createElement(e),n.id=r,n.src=i+"://platform.twitter.com/widgets.js",s.parentNode.insertBefore(n,s))}(document,"script","twitter-wjs")</script><script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://apis.google.com/js/plusone.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="page"> <header> <a href="index.html" id="cs_home">Capstone</a> <nav> <a href="index.html">Home</a> <a href="download.html">Download</a> <a href="documentation.html">Docs</a> <a href="showcase.html">Showcase</a> <a href="testimonial.html">Testimonials</a> <a href="donate.html">Donate</a> <a href="contact.html">Contact</a> </nav> </header> <section><h2 id="customize-instruction-mnemonic-at-run-time">Customize instruction mnemonic at run-time</h2><h3 id="setup-capstone-to-customize-mnemonic">1. Setup Capstone to customize mnemonic</h3><p>In some architectures, an instruction might have alternative mnemonic. Example is the <em>JNE</em> instruction on <em>X86</em>: this is also called <em>JNZ</em> by some disassemblers. The problem is that all the mnemonics are fixed in the engine and cannot be customized. For this reason, some disassembly tools built on top of Capstone have to use some tricks to modify mnemonics at the output for what they desire.</p><p>This has been changed with a new option <strong>CS_OPT_MNEMONIC</strong> (available in the Github branch <a href="https://github.com/aquynh/capstone/tree/next">next</a> now, and will be ready when version <em>4.0</em> is out). Use this option with <em>cs_option()</em> to customize instruction mnemonics, as in the sample C code below.</p><p><br/></p><div class="highlight"><pre><code class="language-c" data-lang="c"><span class="lineno"> 1</span> <span class="n">csh</span> <span class="n">handle</span><span class="p">;</span>
<span class="lineno"> 2</span>
<span class="lineno"> 3</span> <span class="c1">// Customize mnemonic JNE to "jnz"</span>
<span class="lineno"> 4</span> <span class="n">cs_opt_mnem</span> <span class="n">my_mnem</span> <span class="o">=</span> <span class="p">{</span> <span class="n">X86_INS_JNE</span><span class="p">,</span> <span class="s">"jnz"</span> <span class="p">};</span>
<span class="lineno"> 5</span>
<span class="lineno"> 6</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs_open</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS_ERR_OK</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 7</span>     <span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_MNEMONIC</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">my_mnem</span><span class="p">);</span>
<span class="lineno"> 8</span>     <span class="c1">// from here onwards, disassembling will give JNE a mnemonic "jnz"</span>
<span class="lineno"> 9</span>     <span class="c1">// ...</span>
<span class="lineno">10</span> <span class="p">}</span></code></pre></div><p><br/> Below is the explanation for important lines of the above C sample.</p><ul><li><p>Line 4: Declare variables <em>my_mnem</em> of data type <em>cs_opt_mnem</em> to customize <em>JNE</em> instruction (indicated by <em>X86_INS_JNE</em>) to have mnemonic <em>“jnz”</em>.</p></li><li><p>Line 6: Intialize X86 engine of 32-bit mode.</p></li><li><p>Line 7: Call <em>cs_option</em> with option <em>CS_OPT_MNEMONIC</em>, and pass the address of <em>my_mnem</em> in the third parameter. After this, we can start disassembling and instruction <em>JNE</em> will have <em>“jnz”</em> mnemonic, rather than the default value <em>“jne”</em>.</p></li></ul><p><br/> The below Python code does the same thing as the above C sample. The only important difference is that we use method <em>mnemonic_setup()</em> to customize the menemonic of <em>JNE</em> instruction in <em>line 5</em>.</p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="kn">from</span> <span class="nn">capstone</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno">2</span> <span class="kn">from</span> <span class="nn">capstone.x86</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno">3</span>
<span class="lineno">4</span> <span class="n">md</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">)</span>
<span class="lineno">5</span> <span class="n">md</span><span class="o">.</span><span class="n">mnemonic_setup</span><span class="p">(</span><span class="n">X86_INS_JNE</span><span class="p">,</span> <span class="s">"jnz"</span><span class="p">)</span></code></pre></div><p><br/> Finally, note that while the above samples are for X86, the same technique can be applied for all other architectures supported by Capstone. Because we can run <em>cs_option(CS_OPT_MNEMONIC)</em> as many times as we want, there is no limitation on the number of instructions we can customize.</p><hr/><h3 id="reset-capstone-to-the-default-mnemonic">2. Reset Capstone to the default mnemonic</h3><p>After customizing instruction mnemonic as in section 1 above, we can always reset Capstone to the default mnemonic, as in the sample C code below.</p><p><br/></p><div class="highlight"><pre><code class="language-c" data-lang="c"><span class="lineno">1</span> <span class="c1">// Reset instruction JNE to use its default mnemonic</span>
<span class="lineno">2</span> <span class="n">cs_opt_mnem</span> <span class="n">default_mnem</span> <span class="o">=</span> <span class="p">{</span> <span class="n">X86_INS_JNE</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="lineno">3</span>
<span class="lineno">4</span> <span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_MNEMONIC</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">default_mnem</span><span class="p">);</span>
<span class="lineno">5</span> <span class="c1">// from here onwards, our engine will switch back to the default mnemonic "jne" for JNE.</span></code></pre></div><p><br/> Basically, rather than using a string for the mnemonic, we pass the value <em>NULL</em> in <em>line 2</em> when declaring the <em>cs_opt_mnem</em> structure.</p><p><br/> The below Python sample does the same thing to reset the engine, which is self explanatory.</p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="n">md</span><span class="o">.</span><span class="n">mnemonic_setup</span><span class="p">(</span><span class="n">X86_INS_JNE</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></code></pre></div><hr/><h3 id="more-examples">3. More examples</h3><p>Find the full samples on how to use <em>CS_OPT_MNEMONIC</em> in the source of <a href="https://github.com/aquynh/capstone/blob/next/tests/test_customized_mnem.c">test_x86.c</a> or <a href="https://github.com/aquynh/capstone/blob/next/bindings/python/test_customized_mnem.py">test_x86.py</a>.</p><p><br/> When running these samples, the output is as followings.</p><div class="highlight"><pre><code class="language-text" data-lang="text">Disassemble X86 code with default instruction mnemonic
75 01		jne	0x1003

Now customize engine to change mnemonic from 'JNE' to 'JNZ'
75 01		jnz	0x1003

Reset engine to use the default mnemonic
75 01		jne	0x1003</code></pre></div></section> <footer> </footer></div></body></html>