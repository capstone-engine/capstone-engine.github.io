<!DOCTYPE html>
<html>
  <head>
    <title>Access information of operands. – Capstone – The Ultimate Disassembler</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="The Ultimate Disassembler">
    <meta property="og:description" content="The Ultimate Disassembler" />
    
    <meta name="author" content="Capstone" />

    
    <meta property="og:title" content="Access information of operands." />
    <meta property="twitter:title" content="Access information of operands." />
    

    <link rel="icon" type="image/png" sizes="16x16" href="/16x16.png">
    <link rel="icon" type="image/png" sizes="24x24" href="/24x24.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/48x48.png">
    <link rel="icon" type="image/png" sizes="64x64" href="/64x64.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/96x96.png">
    <link rel="icon" type="image/png" sizes="128x128" href="/128x128.png">
    <link rel="icon" type="image/png" sizes="256x256" href="/256x256.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/512x512.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">


    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Capstone - The Ultimate Disassembler" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/img/capstone.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Capstone</a></h1>
            <p class="site-description">The Ultimate Disassembler</p>
          </div>

          <nav>
            <a href="/download.html">Download</a>
            <a href="/documentation.html">Docs</a>
            <a href="/showcase.html">Showcase</a>
            <a href="/testimonial.html">Testimonials</a>
            <a href="/donate.html">Donate</a>
            <a href="/contact.html">Contact</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <h2>Retrieve access information of instruction operands</h2>

<h3>1. Get access info of registers</h3>

<p>Now available in the Github branch <a href="https://github.com/aquynh/capstone/tree/next">next</a>, Capstone provides a new API named <strong>cs_regs_access()</strong>. This function can retrieve the list of all registers <em>read</em> or <em>modified</em> - either implicitly or explicitly - by instructions.</p>

<p><br>
The C sample code below demonstrates how to use <em>cs_regs_access</em> on X86 input.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="lineno"> 1</span> <span class="cp">#include &lt;stdio.h&gt;</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="cp">#include &lt;capstone/capstone.h&gt;</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="cp">#define CODE &quot;\x8d\x4c\x32\x08\x01\xd8&quot;</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="lineno"> 8</span> <span class="p">{</span>
<span class="lineno"> 9</span>   <span class="n">csh</span> <span class="n">handle</span><span class="p">;</span>
<span class="lineno">10</span>   <span class="n">cs_insn</span> <span class="o">*</span><span class="n">insn</span><span class="p">;</span>
<span class="lineno">11</span>   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
<span class="lineno">12</span>   <span class="n">cs_regs</span> <span class="n">regs_read</span><span class="p">,</span> <span class="n">regs_write</span><span class="p">;</span>
<span class="lineno">13</span>   <span class="kt">uint8_t</span> <span class="n">read_count</span><span class="p">,</span> <span class="n">write_count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
<span class="lineno">14</span>   
<span class="lineno">15</span>   <span class="k">if</span> <span class="p">(</span><span class="n">cs_open</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CS_ERR_OK</span><span class="p">)</span>
<span class="lineno">16</span>     <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="lineno">17</span>   
<span class="lineno">18</span>   <span class="n">cs_option</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CS_OPT_DETAIL</span><span class="p">,</span> <span class="n">CS_OPT_ON</span><span class="p">);</span>
<span class="lineno">19</span>   
<span class="lineno">20</span>   <span class="n">count</span> <span class="o">=</span> <span class="n">cs_disasm</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">CODE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CODE</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="p">);</span>
<span class="lineno">21</span>   <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">22</span>     <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">23</span>       <span class="c1">// Print assembly</span>
<span class="lineno">24</span>       <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">insn</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">insn</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">op_str</span><span class="p">);</span>
<span class="lineno">25</span> 
<span class="lineno">26</span>       <span class="c1">// Print all registers accessed by this instruction.</span>
<span class="lineno">27</span>       <span class="k">if</span> <span class="p">(</span><span class="n">cs_regs_access</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">insn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
<span class="lineno">28</span>             <span class="n">regs_read</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_count</span><span class="p">,</span>
<span class="lineno">29</span>             <span class="n">regs_write</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">30</span>         <span class="k">if</span> <span class="p">(</span><span class="n">read_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">31</span>           <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Registers read:&quot;</span><span class="p">);</span>
<span class="lineno">32</span>           <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">read_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">33</span>              <span class="n">printf</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">cs_reg_name</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">regs_read</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="lineno">34</span>           <span class="p">}</span>
<span class="lineno">35</span>           <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="lineno">36</span>         <span class="p">}</span>
<span class="lineno">37</span> 
<span class="lineno">38</span>         <span class="k">if</span> <span class="p">(</span><span class="n">write_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">39</span>           <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Registers modified:&quot;</span><span class="p">);</span>
<span class="lineno">40</span>           <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">write_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">41</span>             <span class="n">printf</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">cs_reg_name</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">regs_write</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
<span class="lineno">42</span>           <span class="p">}</span>
<span class="lineno">43</span>           <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="lineno">44</span>         <span class="p">}</span>
<span class="lineno">45</span>       <span class="p">}</span>
<span class="lineno">46</span>     <span class="p">}</span>
<span class="lineno">47</span> 
<span class="lineno">48</span>     <span class="n">cs_free</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="lineno">49</span>   <span class="p">}</span> <span class="k">else</span>
<span class="lineno">50</span>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;ERROR: Failed to disassemble given code!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="lineno">51</span> 
<span class="lineno">52</span>   <span class="n">cs_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
<span class="lineno">53</span> 
<span class="lineno">54</span>   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="lineno">55</span> <span class="p">}</span></code></pre></div>

<p><br>
Compile and run this sample, we have the output as follows.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">lea    ecx, <span class="o">[</span>edx + esi + 8<span class="o">]</span>

    Registers <span class="nb">read</span>: edx esi
    Registers modified: ecx

add eax, ebx

    Registers <span class="nb">read</span>: eax ebx
    Registers modified: eflags eax</code></pre></div>

<p><br>
Below is the explanation for important lines of the above C sample.</p>

<ul>
<li><p>Line 12: Declare variables <em>regs_read</em> &amp; <em>regs_write</em> of data type <em>cs_regs</em> to keep the list of registers being read or modified later. Note that <em>cs_regs</em> is actually a data type of an array of <em>uint16_t</em>.</p></li>
<li><p>Line 15 ~ 18: Intialize X86 engine, then turn on the <em>DETAIL</em> mode, which is required to get the access information of operands &amp; registers.</p></li>
<li><p>Line 20 ~ 24: Disassemble input code, then print out the assembly of all the instructions.</p></li>
<li><p>Line 27 ~ 29: Retrieve access information of registers with <em>cs_regs_access()</em>. After this, <em>regs_read</em> &amp; <em>regs_write</em> keep all the registers being read &amp; modified by current assembly instructions. Meanwhile, <em>read_count</em> &amp; <em>write_count</em> contain number of registers kept inside array <em>regs_read</em> &amp; <em>regs_write</em>, respectively.</p></li>
<li><p>Line 30 ~ 36: If there are registers being read (see the checking condition <em>read_count &gt; 0</em>), print out these registers inside <em>regs_read</em> array. Register name is retrieved with the API <em>cs_reg_name()</em>.</p></li>
<li><p>Line 38 ~ 44: If there are registers being modified (see the checking condition <em>write_count &gt; 0</em>), print out these registers inside <em>regs_write</em> array.</p></li>
</ul>

<p><br>
For those readers more familiar with Python, the below code does the same thing as the above C sample.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">from</span> <span class="nn">capstone</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="n">CODE</span> <span class="o">=</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\x8d\x4c\x32\x08\x01\xd8</span><span class="s">&quot;</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="n">md</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">(</span><span class="n">CS_ARCH_X86</span><span class="p">,</span> <span class="n">CS_MODE_32</span><span class="p">)</span>
<span class="lineno"> 6</span> <span class="n">md</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="k">for</span> <span class="n">insn</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">disasm</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">):</span>
<span class="lineno"> 9</span>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">insn</span><span class="o">.</span><span class="n">mnemonic</span><span class="p">,</span> <span class="n">insn</span><span class="o">.</span><span class="n">op_str</span><span class="p">))</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>  <span class="p">(</span><span class="n">regs_read</span><span class="p">,</span> <span class="n">regs_write</span><span class="p">)</span> <span class="o">=</span> <span class="n">insn</span><span class="o">.</span><span class="n">regs_access</span><span class="p">()</span>
<span class="lineno">12</span> 
<span class="lineno">13</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regs_read</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">14</span>      <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Registers read:&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="lineno">15</span>      <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regs_read</span><span class="p">:</span>
<span class="lineno">16</span>          <span class="k">print</span><span class="p">(</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">insn</span><span class="o">.</span><span class="n">reg_name</span><span class="p">(</span><span class="n">r</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="lineno">17</span>      <span class="k">print</span><span class="p">()</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regs_write</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">20</span>      <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Registers modified:&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="lineno">21</span>      <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regs_write</span><span class="p">:</span>
<span class="lineno">22</span>          <span class="k">print</span><span class="p">(</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">insn</span><span class="o">.</span><span class="n">reg_name</span><span class="p">(</span><span class="n">r</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="lineno">23</span>      <span class="k">print</span><span class="p">()</span></code></pre></div>

<p><br>
Below is the explanation for important lines of this Python sample.</p>

<ul>
<li><p>Line 5 ~ 6: Intialize X86 engine, then turn on the <em>DETAIL</em> mode, which is required to get the access information of operands &amp; registers.</p></li>
<li><p>Line 8 ~ 9: Disassemble input code, then print out the assembly of all the instructions.</p></li>
<li><p>Line 11: Retrieve access information of registers with <em>regs_access()</em> method. After this, the lists of <em>regs_read</em> &amp; <em>regs_write</em> keep all the registers being read &amp; modified by current assembly instructions.</p></li>
<li><p>Line 13 ~ 17: If there are registers being read (see the checking condition for the length of <em>regs_read</em>), print out these registers inside the list <em>regs_read</em>. Register name is retrieved with method <em>reg_name()</em>.</p></li>
<li><p>Line 19 ~ 23: If there are registers being modified (see the checking condition for the length of <em>regs_write</em>), print out these registers inside the list <em>regs_write</em>.</p></li>
</ul>

<hr>

<h3>2. Get access info of operands</h3>

<p>For instruction operands, besides the information such as <em>size</em> &amp; <em>type</em>, now we can retrieve the access information. This is possible thanks to the new field <em>cs<em>x86</em>op.access</em> in <em>x86.h</em>.</p>

<ul>
<li><p>The value <em>CS<em>AC</em>READ</em> indicates this operand is read.</p></li>
<li><p>The value <em>CS<em>AC</em>WRITE</em> indicates this operand is modified.</p></li>
<li><p>The value <em>(CS<em>AC</em>READ</em> &#124; <em>CS<em>AC</em>WRITE)</em> indicates this operand is read first, then modified later.</p></li>
<li><p>The value <em>CS<em>AC</em>INVALID</em> indicates this operand is not accessed, for example <em>immediate</em> operand.</p></li>
</ul>

<p><br>
With the help of <em>cs<em>x86</em>op.access</em>, we can find out how each instruction operand is accessed, like below.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">lea    ecx, <span class="o">[</span>edx + esi + 8<span class="o">]</span>
    Number of operands: 2
        operands<span class="o">[</span>0<span class="o">]</span>.type: <span class="nv">REG</span> <span class="o">=</span> ecx
        operands<span class="o">[</span>0<span class="o">]</span>.access: WRITE

add eax, ebx
    Number of operands: 2
        operands<span class="o">[</span>0<span class="o">]</span>.type: <span class="nv">REG</span> <span class="o">=</span> eax
        operands<span class="o">[</span>0<span class="o">]</span>.access: READ <span class="p">|</span> WRITE

        operands<span class="o">[</span>1<span class="o">]</span>.type: <span class="nv">REG</span> <span class="o">=</span> ebx
        operands<span class="o">[</span>1<span class="o">]</span>.access: READ</code></pre></div>

<p><br>
Note that instruction <em>LEA</em> do not actually access the second operand, hence this operand is ignored.</p>

<hr>

<h3>3. Status register update</h3>

<p>Arithmetic instructions might update status flags. In X86 case, this is the <em>EFLAGS</em> register. Capstone does not only tell you that <em>EFLAGS</em> is modified, but can also provide details on individual bits inside <em>EFLAGS</em>. Examples are <em>CF</em>, <em>ZF</em>, <em>OF</em>, <em>SF</em> flags and so on.</p>

<p>On X86, this information is available in the field <em>cs_x86.eflags</em>, which is bitwise <em>OR</em> of <em>X86<em>EFLAGS</em>*</em> values. Again, this requires the engine to be configured in <em>DETAIL</em> mode.</p>

<p><br>
See the screenshot below for what this feature can provide.</p>

<p><img src="http://capstone-engine.org/capstone-newapi.png" width="800px"/></p>

<hr>

<h3>4. More examples</h3>

<p>Find the full sample on how to retrieve information on operand access in source of <a href="https://github.com/aquynh/capstone/blob/next/tests/test_x86.c">test_x86.c</a> or <a href="https://github.com/aquynh/capstone/blob/next/bindings/python/test_x86.py">test_x86.py</a>.</p>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:capstone.engine@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/aquynh/capstone"><i class="svg-icon github"></i></a>




<a href="https://www.twitter.com/capstone_engine"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    

  </body>
</html>
